name: Build & Release Android APK

on:
  push:
    tags:
      - 'v*'  # 只有打 tag（如 v1.0.0）时触发构建，适合正式发布

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出主代码仓库
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：检出私有 keystore 仓库（推荐将 .jks 文件存于独立私有仓库）
      - name: Fetch Keystore
        uses: actions/checkout@v4
        with:
          repository: your-username/android-keystore  # 替换为你的私有 keystore 仓库
          path: keystore
          token: ${{ secrets.TOKEN }}  # 用于访问私有仓库的 Personal Access Token

      # 步骤3：设置 Java 环境（推荐 JDK 17）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle  # 缓存 Gradle 依赖，加速后续构建

      # 步骤4：使 gradlew 可执行
      - name: Make Gradle Wrapper Executable
        run: chmod +x ./gradlew

      # 步骤5：复制 keystore 到项目目录，并写入签名配置
      - name: Prepare Signing Configuration
        run: |
          # 复制 keystore 文件到 app 目录
          cp keystore/magic-key.jks app/
          # 生成 gradle.properties 中的签名配置（用于 build.gradle 读取）
          echo "android.signingConfig.storeFile=../app/magic-key.jks" >> gradle.properties
          echo "android.signingConfig.storePassword=${{ secrets.KEY_STORE_PASSWORD }}" >> gradle.properties
          echo "android.signingConfig.keyAlias=${{ secrets.ALIAS }}" >> gradle.properties
          echo "android.signingConfig.keyPassword=${{ secrets.KEY_PASSWORD }}" >> gradle.properties

      # 步骤6：清理构建缓存（可选，确保干净构建）
      - name: Clean Gradle Build
        run: ./gradlew clean

      # 步骤7：构建 Release APK
      - name: Build Release APK
        run: ./gradlew assembleRelease -x lint --info
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # 步骤8：上传 APK 到 GitHub Releases（自动创建 Release 并附加文件）
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
