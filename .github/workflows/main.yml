name: ðŸ› ï¸ Manual Build & Release Android APK

on:
  workflow_dispatch:  # ðŸ‘ˆ å…³é”®ï¼šæ”¹ä¸ºæ‰‹åŠ¨è§¦å‘
    inputs:
      versionCode:
        description: 'APK Version Code (e.g., 101)'
        required: true
        default: '101'
      versionName:
        description: 'APK Version Name (e.g., 1.0.1)'
        required: true
        default: '1.0.1'
      buildType:
        description: 'Build Type (release or debug)'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä¸»ä»£ç ä»“åº“
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šæ£€å‡ºç§æœ‰ keystore ä»“åº“ï¼ˆæŽ¨èå°† .jks å­˜äºŽç‹¬ç«‹ç§æœ‰ä»“åº“ï¼‰


      # æ­¥éª¤3ï¼šè®¾ç½® Java çŽ¯å¢ƒï¼ˆæŽ¨è JDK 17ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle  # ç¼“å­˜ Gradle ä¾èµ–ï¼ŒåŠ é€Ÿæž„å»º

      # æ­¥éª¤4ï¼šä½¿ gradlew å¯æ‰§è¡Œ
      - name: Make Gradle Wrapper Executable
        run: chmod +x ./gradlew

      # æ­¥éª¤5ï¼šå‡†å¤‡ç­¾åé…ç½®ï¼ˆä»Ž gradle.properties è¯»å–ï¼‰
      - name: Prepare Signing Configuration
        run: |
          # å¤åˆ¶ keystore åˆ° app ç›®å½•
          # cp keystore/magic-key.jks app/
          # å†™å…¥ç­¾åé…ç½®åˆ° gradle.properties
          echo "android.signingConfig.storeFile=../app/magic-key.jks" >> gradle.properties
          echo "android.signingConfig.storePassword=${{ secrets.KEY_STORE_PASSWORD }}" >> gradle.properties
          echo "android.signingConfig.keyAlias=${{ secrets.ALIAS }}" >> gradle.properties
          echo "android.signingConfig.keyPassword=${{ secrets.KEY_PASSWORD }}" >> gradle.properties
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # æ­¥éª¤6ï¼šæ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼Œæ ¹æ®è¾“å…¥åŠ¨æ€ä¿®æ”¹ï¼‰
      - name: Update Version in build.gradle
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ github.event.inputs.versionCode }}/" app/build.gradle
          sed -i "s/versionName '[^']*'/versionName '${{ github.event.inputs.versionName }}'/" app/build.gradle
        shell: bash

      # æ­¥éª¤7ï¼šæ¸…ç†æž„å»ºç¼“å­˜
      - name: Clean Gradle Build
        run: ./gradlew clean

      # æ­¥éª¤8ï¼šæž„å»º APKï¼ˆæ ¹æ®è¾“å…¥é€‰æ‹© buildTypeï¼‰
      - name: Set Build Type Capitalized
        id: set-build-type
        run: |
          BUILD_TYPE="${{ github.event.inputs.buildType }}"
          CAPITALIZED=$(echo "${BUILD_TYPE:0:1}" | tr '[:lower:]' '[:upper:]')$(echo "${BUILD_TYPE:1}")
          echo "BUILD_TYPE_CAPITALIZED=$CAPITALIZED" >> $GITHUB_ENV

      - name: Build APK
        run: ./gradlew assemble${{ env.BUILD_TYPE_CAPITALIZED }} -x lint --info

      # æ­¥éª¤9ï¼šä¸Šä¼  APK åˆ° GitHub Releasesï¼ˆè‡ªåŠ¨åˆ›å»º Releaseï¼‰
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/${{ github.event.inputs.buildType }}/*.apk
          tag_name: ${{ github.event.inputs.versionName }}
          target_commitish: main
          name: Release ${{ github.event.inputs.versionName }}
          body: |
            Auto-generated release for version `${{ github.event.inputs.versionName }}` (`v${{ github.event.inputs.versionCode }}`)
            Built via manual GitHub Actions trigger.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
